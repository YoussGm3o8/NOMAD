# MAVLink Router Configuration for NOMAD
# Location: /etc/mavlink-router/main.conf
#
# Installation:
#   sudo apt install mavlink-router
#   sudo cp main.conf /etc/mavlink-router/main.conf
#   sudo systemctl enable mavlink-router
#   sudo systemctl start mavlink-router
#
# Management:
#   sudo systemctl status mavlink-router
#   sudo journalctl -u mavlink-router -f
#
# Purpose:
#   Routes MAVLink telemetry from Flight Controller to:
#   - Orchestrator (127.0.0.1:14550)
#   - Vision Process (127.0.0.1:14551)
#   - Ground Station via Tailscale (100.x.x.x:14550)
#
# Dual Link Setup:
#   This router works in conjunction with RadioMaster transmitter for
#   automatic failover. The ground station (Mission Planner) receives:
#   - LTE/Tailscale link: via this mavlink-router (primary, long range)
#   - RadioMaster link: direct from RC transmitter on port 14550 (backup)
#   
#   Mission Planner's NOMAD plugin monitors both links and switches
#   automatically on connection loss.

[General]
# TCP server for direct connections (optional)
TcpServerPort=5760

# Report statistics periodically
ReportStats=true

# Log to systemd journal
#Log=/var/log/mavlink-router.log

# MAVLink version (1 or 2)
MavlinkDialect=ardupilotmega

# ============================================================
# Flight Controller Input (USB Serial - Cube connected via USB)
# ============================================================

# Primary: USB Serial connection (Cube Orange connected via USB)
[UartEndpoint usb_fc]
Device=/dev/ttyACM0
Baud=921600

# Alternative: UART Serial (if using TELEM port instead of USB)
# [UartEndpoint uart_fc]
# Device=/dev/ttyTHS1
# Baud=921600

# Note: The Cube is connected to Jetson via USB cable.
# Verify device with: ls -l /dev/ttyACM* or dmesg | grep tty
# Grant permissions: sudo usermod -a -G dialout $USER

# ============================================================
# Orchestrator Endpoint (Local)
# ============================================================

[UdpEndpoint orchestrator]
Mode=Normal
Address=127.0.0.1
Port=14550

# The Edge Core orchestrator listens on this port
# for MAVLink telemetry and sends commands back

# ============================================================
# Vision Process Endpoint (Local)
# ============================================================

[UdpEndpoint vision]
Mode=Normal
Address=127.0.0.1
Port=14551

# The Vision Process may need telemetry for:
# - Drone position/attitude for visual servoing
# - Flight mode for behavior adaptation

# ============================================================
# Ground Station Endpoint (via Tailscale)
# ============================================================

[UdpEndpoint groundstation]
Mode=Normal
# Using Tailscale MagicDNS hostname for automatic IP resolution
# TEST CONFIG: Windows laptop ground station (replace with Pi GS for production)
Address=nomad-groundstation-windows.tail1d521d.ts.net
Port=14550

# PRODUCTION: Update to Raspberry Pi ground station address when ready
# Address=nomad-groundstation-pi.tail1d521d.ts.net
#
# To find your Ground Station's Tailscale hostname/IP:
#   tailscale status
#
# This allows Mission Planner to receive telemetry over 4G/LTE
# even when the drone is beyond WiFi range.
#
# Mission Planner should connect to:
#   UDP, port 14550 (listen mode)
#
# The Ground Station can send commands back through this same
# endpoint, and mavlink-router will forward them to the FC.

# ============================================================
# Alternative: ELRS Endpoint (if using ELRS Mavlink passthrough)
# ============================================================

# [UdpEndpoint elrs]
# Mode=Normal
# Address=127.0.0.1
# Port=14552
#
# If using ExpressLRS with MAVLink passthrough, configure this
# endpoint and update your ELRS settings accordingly.

# ============================================================
# Debug: Local UDP broadcast (optional)
# ============================================================

# [UdpEndpoint debug]
# Mode=Normal
# Address=127.0.0.1
# Port=14553
#
# Use this for debugging with tools like mavproxy or QGroundControl
# running locally on the Jetson.

# ============================================================
# Notes
# ============================================================
#
# 1. Verify serial device:
#    ls -l /dev/ttyTHS*
#    dmesg | grep tty
#
# 2. Grant permissions if needed:
#    sudo usermod -a -G dialout nomad
#
# 3. Test MAVLink stream:
#    mavproxy.py --master=/dev/ttyTHS1 --baud 921600
#
# 4. Verify Tailscale connectivity:
#    ping <groundstation-tailscale-ip>
#
# 5. Mission Planner connection:
#    - Connect to UDP, port 14550
#    - Ensure Windows Firewall allows UDP 14550
