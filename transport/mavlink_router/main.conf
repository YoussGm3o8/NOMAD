# MAVLink Router Configuration for NOMAD
# Location: /etc/mavlink-router/main.conf
#
# Installation:
#   sudo apt install mavlink-router
#   sudo cp main.conf /etc/mavlink-router/main.conf
#   sudo systemctl enable mavlink-router
#   sudo systemctl start mavlink-router
#
# Management:
#   sudo systemctl status mavlink-router
#   sudo journalctl -u mavlink-router -f
#
# Purpose:
#   Routes MAVLink telemetry from Flight Controller to:
#   - Orchestrator (127.0.0.1:14550)
#   - Vision Process (127.0.0.1:14551)
#   - Ground Station via Tailscale (100.x.x.x:14550)

[General]
# TCP server for direct connections (optional)
TcpServerPort=5760

# Report statistics periodically
ReportStats=true

# Log to systemd journal
#Log=/var/log/mavlink-router.log

# MAVLink version (1 or 2)
MavlinkDialect=ardupilotmega

# ============================================================
# Flight Controller Input (UART/Serial)
# ============================================================

[UartEndpoint alpha]
Device=/dev/ttyTHS1
Baud=921600

# Alternative devices for different Jetson models:
# Orin Nano: /dev/ttyTHS1
# Xavier NX: /dev/ttyTHS0
# AGX Orin: /dev/ttyTCU0

# Alternative for USB serial (e.g., FTDI adapter):
# Device=/dev/ttyUSB0
# Baud=921600

# ============================================================
# Orchestrator Endpoint (Local)
# ============================================================

[UdpEndpoint orchestrator]
Mode=Normal
Address=127.0.0.1
Port=14550

# The Edge Core orchestrator listens on this port
# for MAVLink telemetry and sends commands back

# ============================================================
# Vision Process Endpoint (Local)
# ============================================================

[UdpEndpoint vision]
Mode=Normal
Address=127.0.0.1
Port=14551

# The Vision Process may need telemetry for:
# - Drone position/attitude for visual servoing
# - Flight mode for behavior adaptation

# ============================================================
# Ground Station Endpoint (via Tailscale)
# ============================================================

[UdpEndpoint groundstation]
Mode=Normal
Address=100.76.127.17
Port=14550

# IMPORTANT: Replace 100.100.100.100 with your Ground Station's
# Tailscale IP address. Find it with:
#   tailscale ip -4
#
# This allows Mission Planner to receive telemetry over 4G/LTE
# even when the drone is beyond WiFi range.
#
# Mission Planner should connect to:
#   UDP, port 14550 (listen mode)
#
# The Ground Station can send commands back through this same
# endpoint, and mavlink-router will forward them to the FC.

# ============================================================
# Alternative: ELRS Endpoint (if using ELRS Mavlink passthrough)
# ============================================================

# [UdpEndpoint elrs]
# Mode=Normal
# Address=127.0.0.1
# Port=14552
#
# If using ExpressLRS with MAVLink passthrough, configure this
# endpoint and update your ELRS settings accordingly.

# ============================================================
# Debug: Local UDP broadcast (optional)
# ============================================================

# [UdpEndpoint debug]
# Mode=Normal
# Address=127.0.0.1
# Port=14553
#
# Use this for debugging with tools like mavproxy or QGroundControl
# running locally on the Jetson.

# ============================================================
# Notes
# ============================================================
#
# 1. Verify serial device:
#    ls -l /dev/ttyTHS*
#    dmesg | grep tty
#
# 2. Grant permissions if needed:
#    sudo usermod -a -G dialout nomad
#
# 3. Test MAVLink stream:
#    mavproxy.py --master=/dev/ttyTHS1 --baud 921600
#
# 4. Verify Tailscale connectivity:
#    ping <groundstation-tailscale-ip>
#
# 5. Mission Planner connection:
#    - Connect to UDP, port 14550
#    - Ensure Windows Firewall allows UDP 14550
